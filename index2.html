<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Hovedstyret ordtavle (mobil)</title>
<style>
  :root{ --gap:10px; --maxw:420px; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:12px}
  h1{font-size:20px;margin:0 0 6px}
  p{margin:6px 0 10px}
  /* Kameravisning – kompakt og sticky, så knapper altid kan ses */
  .cam{
    position: sticky; top: 6px; z-index: 1;
    width: 100%; max-width: var(--maxw); margin: 0 auto 10px;
    aspect-ratio: 4 / 3; border-radius: 12px; overflow: hidden; background:#000;
  }
  .cam video,.cam canvas{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
  /* Grid med 3×3 knapper */
  .grid{
    display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap);
    width:100%; max-width:var(--maxw); margin:0 auto;
  }
  .cell{
    min-height: clamp(72px, 18vw, 110px);
    display:flex; align-items:center; justify-content:center;
    border-radius:12px; border:2px solid #ddd; background:#f7f7f7;
    font-weight:700; font-size: clamp(18px, 4.5vw, 22px); text-align:center; padding:6px;
  }
  .cell.sel{ outline:4px solid #4a90e2; background:#eaf2fe; border-color:#4a90e2 }
  /* Kontroller – små, kompakte */
  .panel{max-width:var(--maxw); margin:10px auto}
  label{font-size:12px;opacity:.85}
  input[type=range]{width:100%}
  .pill{display:inline-block;background:#eef;padding:2px 8px;border-radius:999px;margin-left:6px}
  #status{margin:6px 0 8px}
  button{padding:10px 14px;border-radius:8px;border:1px solid #ccc;background:#fff}
  .meters{display:flex;gap:8px;font:12px/1.2 system-ui;max-width:var(--maxw);margin:6px auto}
  .meter{background:#eee;border-radius:6px;overflow:hidden;flex:1;height:8px;position:relative}
  .bar{position:absolute;left:50%;top:0;bottom:0;width:2px;background:#4a90e2}
  .barW{left:0}
</style>
</head>
<body>
<h1>Hovedstyret ordtavle</h1>
<p>Se mod kameraet. Venstre/højre bevægelse skifter kolonne, op/ned skifter række. Åbn <b>munden</b> i ~3 sek. for at vælge. Tryk <b>Start</b> først.</p>

<div class="cam">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>
</div>

<div class="meters">
  <div style="flex:1">Yaw<div class="meter"><div id="yawBar" class="bar"></div></div></div>
  <div style="flex:1">Pitch<div class="meter"><div id="pitchBar" class="bar barW"></div></div></div>
  <div style="flex:1">Mund<div class="meter"><div id="mouthBar" class="bar barW"></div></div></div>
</div>

<div class="panel">
  <button id="startBtn">Start (kamera + lyd)</button>
  <div id="status">Status: klar</div>
</div>

<div class="grid" id="grid">
  <div class="cell">Ja</div>
  <div class="cell">Nej</div>
  <div class="cell">Sulten</div>
  <div class="cell">Toilet</div>
  <div class="cell">Far</div>
  <div class="cell">Mor</div>
  <div class="cell">Træt</div>
  <div class="cell">Tak</div>
  <div class="cell">Hjælp</div>
</div>

<div class="panel">
  <div>
    <label>Yaw-tærskel <span class="pill" id="yawVal">0.060</span></label>
    <input id="yawThr" type="range" min="0.02" max="0.12" step="0.002" value="0.060">
  </div>
  <div>
    <label>Pitch-tærskel <span class="pill" id="pitchVal">0.055</span></label>
    <input id="pitchThr" type="range" min="0.02" max="0.12" step="0.002" value="0.055">
  </div>
  <div>
    <label>Mund-åben (forhold) <span class="pill" id="mouthVal">0.32</span></label>
    <input id="mouthThr" type="range" min="0.15" max="0.60" step="0.01" value="0.32">
  </div>
  <div>
    <label>Holdetid (sek.) <span class="pill" id="holdVal">3.0</span></label>
    <input id="holdSec" type="range" min="1" max="5" step="0.5" value="3">
  </div>
</div>

<!-- RIGTIGE MediaPipe UMD-filer -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
(() => {
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const statusEl = document.getElementById('status');
  const yawBar = document.getElementById('yawBar');
  const pitchBar = document.getElementById('pitchBar');
  const mouthBar = document.getElementById('mouthBar');

  const yawThrEl = document.getElementById('yawThr');
  const pitchThrEl = document.getElementById('pitchThr');
  const mouthThrEl = document.getElementById('mouthThr');
  const holdSecEl = document.getElementById('holdSec');
  const yawVal = document.getElementById('yawVal');
  const pitchVal = document.getElementById('pitchVal');
  const mouthVal = document.getElementById('mouthVal');
  const holdVal = document.getElementById('holdVal');

  const gridEl = document.getElementById('grid');
  const cells = [...gridEl.querySelectorAll('.cell')];
  let r=0,c=0; function focus(){ cells.forEach(x=>x.classList.remove('sel')); cells[r*3+c].classList.add('sel'); } focus();

  const fmt = (n,d=3)=> (+n).toFixed(d);
  function updUI(){ yawVal.textContent=fmt(yawThrEl.value); pitchVal.textContent=fmt(pitchThrEl.value); mouthVal.textContent=fmt(mouthThrEl.value,2); holdVal.textContent=(+holdSecEl.value).toFixed(1); }
  [yawThrEl,pitchThrEl,mouthThrEl,holdSecEl].forEach(el=> el.oninput = updUI); updUI();

  // Sticky canvas size
  function sizeCanvas(){
    const rect = video.getBoundingClientRect();
    overlay.width = rect.width * devicePixelRatio;
    overlay.height = rect.height * devicePixelRatio;
  }
  window.addEventListener('resize', sizeCanvas);

  // Audio feedback + tale
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  function beep(freq=880,ms=120){
    if(!audioCtx) return;
    const g=audioCtx.createGain(), o=audioCtx.createOscillator();
    g.gain.value = 0.12; o.frequency.value=freq;
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+ms/1000);
  }
  function speak(text){ const u=new SpeechSynthesisUtterance(text); u.lang='da-DK'; speechSynthesis.cancel(); speechSynthesis.speak(u); }

  // Helpers
  const IDX={ nose:4, leftEyeOuter:33, rightEyeOuter:263, mouthLeft:61, mouthRight:291, mouthUp:13, mouthDown:14 };
  const dist=(a,b)=> Math.hypot(a.x-b.x, a.y-b.y);

  let lastMove=0;
  function tryMove(dr,dc){
    const now = performance.now();
    if (now - lastMove < 350) return;
    const nr=Math.max(0,Math.min(2,r+dr)), nc=Math.max(0,Math.min(2,c+dc));
    if(nr!==r || nc!==c){ r=nr; c=nc; focus(); beep(660,90); lastMove=now; }
  }

  let mouthOpenSince=null;

  function setYawBar(v){ const cl=Math.max(-0.15,Math.min(0.15,v)); const px=(cl/0.30+0.5)*100; yawBar.style.left=px+'%'; }
  function setPitchBar(v){ pitchBar.style.width=Math.max(0,Math.min(100,(Math.abs(v)/0.15)*100))+'%'; }
  function setMouthBar(v){ mouthBar.style.width=Math.max(0,Math.min(100,(v/0.6)*100))+'%'; }

  // MediaPipe
  let fm=null, cam=null;

  async function start(){
    try{
      if(!audioCtx){ audioCtx=new AudioCtx(); await audioCtx.resume(); }

      const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user', width:{ideal:640}, height:{ideal:480}}, audio:false });
      video.srcObject=stream; await video.play(); sizeCanvas();

      fm = new FaceMesh({
        locateFile: (f)=> `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
      });
      fm.setOptions({ maxNumFaces:1, refineLandmarks:true, selfieMode:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
      fm.onResults(onResults);

      cam = new Camera(video, { onFrame: async()=>{ await fm.send({image:video}); }, width: 320, height: 240 });
      cam.start();

      statusEl.textContent='Status: kører – bevæg hovedet for at flytte fokus. Åbn munden for at vælge.';
    }catch(e){
      console.error(e);
      statusEl.textContent='Fejl: '+(e?.message||e);
    }
  }
  startBtn.addEventListener('click', start);

  function drawPoints(lm){
    const w=overlay.width, h=overlay.height;
    ctx.clearRect(0,0,w,h);
    ctx.save(); ctx.scale(w,h);
    const pts=[IDX.leftEyeOuter,IDX.rightEyeOuter,IDX.mouthLeft,IDX.mouthRight,IDX.mouthUp,IDX.mouthDown,IDX.nose];
    ctx.fillStyle='rgba(255,255,255,.9)';
    for(const i of pts){ const p=lm[i]; ctx.beginPath(); ctx.arc(p.x,p.y,0.012,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }

  function onResults(res){
    if(!res.multiFaceLandmarks || !res.multiFaceLandmarks.length){
      statusEl.textContent='Status: Finder ikke ansigt – prøv bedre lys/tættere på.'; return;
    }
    const lm = res.multiFaceLandmarks[0];
    drawPoints(lm);

    const L=lm[IDX.leftEyeOuter], R=lm[IDX.rightEyeOuter];
    const mid={x:(L.x+R.x)/2, y:(L.y+R.y)/2}, eyeDist=dist(L,R)+1e-6;
    const N=lm[IDX.nose];
    const yaw=(N.x-mid.x)/eyeDist;       // venstre<0, højre>0
    const pitch=(N.y-mid.y)/eyeDist;     // ned>0, op<0
    setYawBar(yaw); setPitchBar(pitch);

    const yawThr=+yawThrEl.value, pitchThr=+pitchThrEl.value;
    if(yaw> yawThr) tryMove(0,+1);
    if(yaw<-yawThr) tryMove(0,-1);
    if(pitch> pitchThr) tryMove(+1,0);
    if(pitch<-pitchThr) tryMove(-1,0);

    // Mund-åben ratio
    const ML=lm[IDX.mouthLeft], MR=lm[IDX.mouthRight], MU=lm[IDX.mouthUp], MD=lm[IDX.mouthDown];
    const ratio = dist(MU,MD) / (dist(ML,MR)+1e-6);
    setMouthBar(ratio);

    const thr=+mouthThrEl.value, needMs=(+holdSecEl.value)*1000;
    if(ratio>thr){
      if(!mouthOpenSince) mouthOpenSince=performance.now();
      const held=performance.now()-mouthOpenSince;
      statusEl.textContent=`Åben mund: ${(held/1000).toFixed(1)}s / ${(+holdSecEl.value).toFixed(1)}s`;
      if(held>=needMs){
        mouthOpenSince=null;
        const text=cells[r*3+c].textContent.trim();
        beep(880,140); speak(text);
        statusEl.textContent=`Valgt: ${text}`;
        lastMove=performance.now(); // lille cooldown
      }
    }else{
      mouthOpenSince=null;
    }
  }
})();
</script>
</body>
</html>
